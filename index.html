<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <style>
    .hidden {
      display: none;
    }

    div.tooltip {
      color: #222;
      background-color: #fff;
      padding: .5em;
      text-shadow: #f5f5f5 0 1px 0;
      border-radius: 2px;
      opacity: 0.9;
      position: absolute;
    }

    body {
      display: flex;
      flex-direction: column;
      margin: 0;
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
    }

    .region {
      fill: #000;
      stroke: #fff;
      stroke-width: 1px;
    }



    .slider-wrapper input {
      width: 180px;
      height: 10px;
      position: relative;

    }

    .spanner {
      margin-top: 5px;
      margin-bottom: : 5px;
      font-weight: bold;
    }

    div {
      display: flex;
      align-items: center;
    }

    .slider-wrapper {
      width: 700px;
      height: 45px;
      display: flex;
      flex-direction: column;

    }

    defs {
      -webkit-align-items: center;
      justify-content: center;
    }
  </style>
</head>

<body>
  <div class="slider-wrapper">
    <span class="spanner" id="week"></span>
    <input id="slider" type="range" value="1" min="1" max="52" step="1" />
  </div>
  <script>
    var width = 700,
      height = 580;

    var svg1 = d3.select("body")
      .append("svg")
      .attr("id", "colorlegend")
      .attr("width", width)
      .attr("height", 20);

    svg1.append("text")
      .attr('id', 'textmax')
      .style("fill", "black")
      .attr("postion", "relative")
      .style("font-weight", "bold")
      .attr("text-anchor", "middle")
      .attr('font-size', '8pt')
      .attr("x", width / 2 + 162)
      .attr("y", 12)

    svg1.append("text")
      .attr("id", 'textmin')
      .style("fill", "black")
      .attr("postion", "relative")
      .style("font-weight", "bold")
      .attr("text-anchor", "middle")
      .attr('font-size', '8pt')
      .attr("x", width / 2 - 162)
      .attr("y", 12)

    var svg = d3.select("body")
      .append("svg")
      .attr("width", width)
      .attr("height", height);

    var projection = d3.geoConicConformal().center([2.454071, 46.279229]).scale(2800)
      .translate([width / 2, height / 2]);

    var path = d3.geoPath() // d3.geo.path avec d3 version 3
      .projection(projection);


    d3.csv("GrippeFrance2014.csv", function(data) {

      d3.json("geo.json", function(json) {
        svg.selectAll(".region")
          .data(json.features)
          .enter()
          .append("path")
          .attr('class', 'region')
          .attr("d", path);

        //Append a defs (for definition) element to your SVG
        var defs = svg.append("defs");

        //Append a linearGradient element to the defs and give it a unique id
        var linearGradient = defs.append("linearGradient")
          .attr("id", "linear-gradient");

        //Set the color for the start (0%)
        linearGradient.append("stop")
          .attr("offset", "0%")
          .attr("stop-color", "#FFCDD2"); //light blue

        //Set the color for the end (100%)
        linearGradient.append("stop")
          .attr("offset", "100%")
          .attr("stop-color", "#B71C1C"); //dark blue

        //Draw the rectangle and fill with gradient
        svg1.append("rect")
          .attr("rx",5)
          .attr("stroke","black")
          .attr("width", 300)
          .attr("height", 10)
          .style("fill", "url(#linear-gradient)")
          .attr("x", width / 2 - 150)
          .attr('y', 3);

        var tooltip = d3.select('body').append('div')
          .attr('class', 'hidden tooltip');

        dict = {}
        //On initalise tout max, texte, slider à la semaine 1
        var max = d3.max(data, function(d) {
          return +d[Object.keys(data[0])[1]];
        })

        var min = d3.min(data, function(d) {
          return +d[Object.keys(data[0])[1]];
        })

        d3.select("#slider").property("value", 1);
        d3.select("#week").text("Semaine du " + Object.keys(data[0])[1]);

        var colorScale = d3.scaleLinear().domain([0, max]).interpolate(d3.interpolateHcl).range(['#FFCDD2', '#B71C1C']);

        function valueByWeek(numWeek) {
          var max = d3.max(data, function(d) {
            return +d[Object.keys(data[0])[numWeek]];
          })

          var min = d3.min(data, function(d) {
            return +d[Object.keys(data[0])[numWeek]];
          })

          colorScale = d3.scaleLinear().domain([0, max]).interpolate(d3.interpolateHcl).range(['#FFCDD2', '#B71C1C']);

          for (var i = 0; i < data.length; i++) {
            json.features.forEach(function(element) {
              if (element.properties.nom == data[i].region) {
                element.properties.value = data[i][Object.keys(data[0])[numWeek]]
              }
            })
            //Au départ j'ai utilisé un dictionnaire pour stocker un calcul intermédiaire, pour chaque région la somme des semaines de novembre
            //Avec un if sur les clés du tableau csv, qui s'ajoutent dans la variable sum si elles contiennent "11/14"
            //Je les gardais pour la fin du projet mais il n'est pas utile.

            sum = 0
            sum += parseFloat(data[i][Object.keys(data[i])[numWeek]])
            dict[data[i]["region"]] = sum
          }
          svg1.select("#textmax")
            .text(max)

          svg1.select("#textmin")
            .text(min)

          Draw();
        };


        valueByWeek(1);
        d3.select("#slider").on("input", function(d) {
          // adjust the text on the range slider
          d3.select("#week").text("Semaine du " + Object.keys(data[0])[+this.value]);
          valueByWeek(+this.value)
        });


        function Draw() {


          svg.selectAll(".region")
            .style("fill", function(d) {

              return colorScale(d.properties.value)

            })
            .on('mouseover', function(d) {
              d3.select(this).style("fill", function(d) {

                  return colorScale(d.properties.value)

                })
                .style("opacity", 0.5)
            })
            .on('mousemove', function(d) {
              var mouse = d3.mouse(svg.node()).map(function(d) {
                return parseInt(d);
              });
              tooltip.classed('hidden', false)
                .attr('style', 'left:' + (mouse[0] + 5) +
                  'px; top:' + (mouse[1] - 5) + "px;")
                .html("<b>" + d.properties.nom + "</b>" + ':\n' + dict[d.properties.nom]);
            })
            .on('mouseout', function() {
              tooltip.classed('hidden', true);
              d3.select(this).style("fill", function(d) {

                return colorScale(d.properties.value)

              }).style("opacity", 1)
            });
        }

        /*svg.selectAll("text")
          .data(json.features)
          .enter()
          .append("text")
          .text(function(d, i) {
            return dict[d.properties.nom]
          })
          .attr("x", function(d) {
            return path.centroid(d)[0];
          })
          .attr("y", function(d) {
            return path.centroid(d)[1];
          })
          .attr("text-anchor", "middle")
          .attr('font-size', '6pt');*/

      });
    });
  </script>
</body>
